<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶è¨ˆç°¿åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - 2008-2025</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .filter-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
            margin: 4px;
            font-weight: 600;
        }
        .filter-btn:hover, .filter-btn.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
            color: #64748b;
            font-size: 1rem;
        }
        .tab-btn:hover { color: #667eea; }
        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        canvas { max-height: 450px; }
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.5rem;
        }
        .insight-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-right: 8px;
        }
        .badge-success { background: #10b981; color: white; }
        .badge-warning { background: #f59e0b; color: white; }
        .badge-info { background: #3b82f6; color: white; }
        
        @media (max-width: 768px) {
            .stat-value { font-size: 1.8rem; }
            .card { padding: 16px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // APIè¨­å®š - æœ¬ç•ªç’°å¢ƒã§ã¯å®Ÿéš›ã®APIãƒ‘ã‚¹ã«å¤‰æ›´
        const API_BASE_URL = '/api/analytics-api.php';
        const USE_DEMO_DATA = true; // false ã«ã™ã‚‹ã¨å®Ÿéš›ã®APIã‚’ä½¿ç”¨

        // APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
        const API = {
            async fetchData(action, params = {}) {
                if (USE_DEMO_DATA) {
                    return this.getDemoData(action, params);
                }
                
                const queryString = new URLSearchParams({ action, ...params }).toString();
                const response = await fetch(`${API_BASE_URL}?${queryString}`);
                const data = await response.json();
                return data;
            },

            // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            getDemoData(action, params) {
                return new Promise(resolve => {
                    setTimeout(() => {
                        switch(action) {
                            case 'summary':
                                resolve(this.generateSummary());
                                break;
                            case 'monthly':
                                resolve(this.generateMonthly());
                                break;
                            case 'yearly':
                                resolve(this.generateYearly());
                                break;
                            case 'shop':
                                resolve(this.generateShop());
                                break;
                            case 'category':
                                resolve(this.generateCategory());
                                break;
                            case 'stats':
                                resolve(this.generateStats());
                                break;
                            default:
                                resolve({ success: true, data: [] });
                        }
                    }, 300);
                });
            },

            generateSummary() {
                return {
                    success: true,
                    data: {
                        period: { start: '2008-01-01', end: '2025-10-27', total_months: 214, total_years: 17.8 },
                        totals: { expense: 42500000, transactions: 15234, active_days: 4521 },
                        averages: { monthly_expense: 198600, daily_expense: 9400, transaction_amount: 2790 },
                        diversity: { unique_shops: 87, unique_categories: 12 }
                    }
                };
            },

            generateMonthly() {
                const data = [];
                for (let year = 2008; year <= 2025; year++) {
                    const maxMonth = year === 2025 ? 10 : 12;
                    for (let month = 1; month <= maxMonth; month++) {
                        const base = 180000;
                        const trend = (year - 2008) * 3000;
                        const seasonal = Math.sin((month - 1) / 12 * Math.PI * 2) * 15000;
                        const random = (Math.random() - 0.5) * 20000;
                        
                        data.push({
                            month: `${year}-${String(month).padStart(2, '0')}`,
                            year, month_num: month,
                            expense: Math.round(base + trend + seasonal + random),
                            transaction_count: Math.round(50 + Math.random() * 30),
                            active_days: Math.round(20 + Math.random() * 8)
                        });
                    }
                }
                return { success: true, data, count: data.length };
            },

            generateYearly() {
                const data = [];
                for (let year = 2008; year <= 2025; year++) {
                    const months = year === 2025 ? 10 : 12;
                    data.push({
                        year,
                        total_expense: Math.round(2000000 + (year - 2008) * 100000 + Math.random() * 200000),
                        transaction_count: Math.round(700 + Math.random() * 200),
                        months_count: months,
                        unique_shops: Math.round(30 + Math.random() * 20)
                    });
                }
                return { success: true, data };
            },

            generateShop() {
                const shops = [
                    'ã‚¹ãƒ¼ãƒ‘ãƒ¼A', 'ã‚¹ãƒ¼ãƒ‘ãƒ¼B', 'ã‚³ãƒ³ãƒ“ãƒ‹C', 'ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢D', 
                    'Amazon', 'æ¥½å¤©å¸‚å ´', 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³E', 'ã‚«ãƒ•ã‚§F', 'ã‚¬ã‚½ãƒªãƒ³ã‚¹ã‚¿ãƒ³ãƒ‰', 'æ›¸åº—'
                ];
                const data = shops.map((shop, idx) => ({
                    cat_1: idx + 1,
                    shop_name: shop,
                    total: Math.round(800000 / (idx + 1) + Math.random() * 100000),
                    transaction_count: Math.round(200 / (idx + 1)),
                    avg_amount: Math.round(3000 + Math.random() * 2000)
                }));
                return { success: true, data };
            },

            generateCategory() {
                const categories = [
                    'é£Ÿè²»', 'æ—¥ç”¨å“', 'äº¤é€šè²»', 'å¨¯æ¥½', 'å¤–é£Ÿ', 'åŒ»ç™‚è²»', 
                    'å…‰ç†±è²»', 'é€šä¿¡è²»', 'è¢«æœè²»', 'æ•™è‚²è²»', 'æ›¸ç±', 'ãã®ä»–'
                ];
                const data = categories.map((cat, idx) => ({
                    cat_2: idx + 1,
                    category_name: cat,
                    total: Math.round(500000 / (idx + 1) + Math.random() * 100000),
                    transaction_count: Math.round(300 / (idx + 1)),
                    avg_amount: Math.round(2500 + Math.random() * 2000)
                }));
                return { success: true, data };
            },

            generateStats() {
                return {
                    success: true,
                    data: {
                        weekday: [
                            { day_of_week: 'Sunday', day_num: 1, avg_expense: 12500 },
                            { day_of_week: 'Monday', day_num: 2, avg_expense: 8900 },
                            { day_of_week: 'Tuesday', day_num: 3, avg_expense: 9200 },
                            { day_of_week: 'Wednesday', day_num: 4, avg_expense: 9500 },
                            { day_of_week: 'Thursday', day_num: 5, avg_expense: 9800 },
                            { day_of_week: 'Friday', day_num: 6, avg_expense: 11200 },
                            { day_of_week: 'Saturday', day_num: 7, avg_expense: 13500 }
                        ],
                        seasonal: Array.from({length: 12}, (_, i) => ({
                            month: i + 1,
                            avg_expense: 180000 + Math.sin(i / 12 * Math.PI * 2) * 20000
                        }))
                    }
                };
            }
        };

        // ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        const FinanceAnalyticsDashboard = () => {
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('overview');
            const [periodFilter, setPeriodFilter] = useState('all');
            const [selectedYear, setSelectedYear] = useState('2025');
            
            const [summary, setSummary] = useState(null);
            const [monthlyData, setMonthlyData] = useState([]);
            const [yearlyData, setYearlyData] = useState([]);
            const [shopData, setShopData] = useState([]);
            const [categoryData, setCategoryData] = useState([]);
            const [statsData, setStatsData] = useState(null);

            useEffect(() => {
                loadAllData();
            }, []);

            const loadAllData = async () => {
                setLoading(true);
                try {
                    const [summaryRes, monthlyRes, yearlyRes, shopRes, categoryRes, statsRes] = await Promise.all([
                        API.fetchData('summary'),
                        API.fetchData('monthly'),
                        API.fetchData('yearly'),
                        API.fetchData('shop', { limit: 10 }),
                        API.fetchData('category'),
                        API.fetchData('stats')
                    ]);

                    if (summaryRes.success) setSummary(summaryRes.data);
                    if (monthlyRes.success) setMonthlyData(monthlyRes.data);
                    if (yearlyRes.success) setYearlyData(yearlyRes.data);
                    if (shopRes.success) setShopData(shopRes.data);
                    if (categoryRes.success) setCategoryData(categoryRes.data);
                    if (statsRes.success) setStatsData(statsRes.data);
                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                } finally {
                    setLoading(false);
                }
            };

            const filteredMonthly = useMemo(() => {
                if (!monthlyData.length) return [];
                if (periodFilter === 'all') return monthlyData;
                if (periodFilter === 'recent') return monthlyData.slice(-12);
                if (periodFilter === 'year') {
                    return monthlyData.filter(d => d.year === parseInt(selectedYear));
                }
                return monthlyData;
            }, [monthlyData, periodFilter, selectedYear]);

            if (loading) {
                return <div className="loading">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>;
            }

            return (
                <div className="dashboard-container">
                    <header className="text-center mb-8">
                        <h1 className="text-5xl font-bold text-white mb-3">
                            ğŸ’° å®¶è¨ˆç°¿åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                        </h1>
                        <p className="text-xl text-white opacity-90">
                            {summary?.period.start} ã€œ {summary?.period.end} 
                            ï¼ˆ{summary?.period.total_years}å¹´é–“ã®ãƒ‡ãƒ¼ã‚¿ï¼‰
                        </p>
                    </header>

                    {/* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
                    <div className="card mb-6">
                        <div className="flex flex-wrap justify-center gap-2">
                            <button className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
                                onClick={() => setActiveTab('overview')}>ğŸ“Š æ¦‚è¦</button>
                            <button className={`tab-btn ${activeTab === 'trends' ? 'active' : ''}`}
                                onClick={() => setActiveTab('trends')}>ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰</button>
                            <button className={`tab-btn ${activeTab === 'breakdown' ? 'active' : ''}`}
                                onClick={() => setActiveTab('breakdown')}>ğŸ¥§ å†…è¨³</button>
                            <button className={`tab-btn ${activeTab === 'insights' ? 'active' : ''}`}
                                onClick={() => setActiveTab('insights')}>ğŸ’¡ åˆ†æ</button>
                        </div>
                    </div>

                    {/* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
                    {activeTab === 'overview' && (
                        <OverviewTab 
                            summary={summary}
                            monthlyData={filteredMonthly}
                            yearlyData={yearlyData}
                        />
                    )}
                    {activeTab === 'trends' && (
                        <TrendsTab 
                            monthlyData={monthlyData}
                            periodFilter={periodFilter}
                            setPeriodFilter={setPeriodFilter}
                            selectedYear={selectedYear}
                            setSelectedYear={setSelectedYear}
                            filteredData={filteredMonthly}
                        />
                    )}
                    {activeTab === 'breakdown' && (
                        <BreakdownTab 
                            shopData={shopData}
                            categoryData={categoryData}
                        />
                    )}
                    {activeTab === 'insights' && (
                        <InsightsTab 
                            monthlyData={monthlyData}
                            statsData={statsData}
                        />
                    )}
                </div>
            );
        };

        // æ¦‚è¦ã‚¿ãƒ–
        const OverviewTab = ({ summary, monthlyData, yearlyData }) => {
            if (!summary) return null;

            const recent12 = monthlyData.slice(-12);
            const recent12Total = recent12.reduce((sum, m) => sum + m.expense, 0);
            const recent12Avg = recent12Total / 12;

            return (
                <div>
                    {/* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div className="stat-card">
                            <div className="stat-label">ç·æ”¯å‡ºé¡</div>
                            <div className="stat-value">
                                Â¥{(summary.totals.expense / 1000000).toFixed(1)}M
                            </div>
                            <div className="stat-label">
                                {summary.period.total_months}ãƒ¶æœˆåˆ†
                            </div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">æœˆå¹³å‡æ”¯å‡º</div>
                            <div className="stat-value">
                                Â¥{(summary.averages.monthly_expense / 1000).toFixed(0)}K
                            </div>
                            <div className="stat-label">
                                17å¹´é–“ã®å¹³å‡
                            </div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">ç·å–å¼•æ•°</div>
                            <div className="stat-value">
                                {summary.totals.transactions.toLocaleString()}
                            </div>
                            <div className="stat-label">
                                {summary.totals.active_days}æ—¥é–“
                            </div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">åˆ©ç”¨åº—èˆ—æ•°</div>
                            <div className="stat-value">
                                {summary.diversity.unique_shops}
                            </div>
                            <div className="stat-label">
                                {summary.diversity.unique_categories}ã‚«ãƒ†ã‚´ãƒª
                            </div>
                        </div>
                    </div>

                    {/* 17å¹´é–“ã®æ¨ç§»ã‚°ãƒ©ãƒ• */}
                    <YearlyTrendChart yearlyData={yearlyData} />
                    
                    {/* ç›´è¿‘12ãƒ¶æœˆ */}
                    <div className="card">
                        <h3 className="text-2xl font-bold mb-4">ğŸ“… ç›´è¿‘12ãƒ¶æœˆã®æ¨ç§»</h3>
                        <div className="grid md:grid-cols-2 gap-6 mb-6">
                            <div className="text-center p-4 bg-blue-50 rounded-lg">
                                <div className="text-sm text-gray-600">12ãƒ¶æœˆåˆè¨ˆ</div>
                                <div className="text-3xl font-bold text-blue-600">
                                    Â¥{(recent12Total / 1000000).toFixed(2)}M
                                </div>
                            </div>
                            <div className="text-center p-4 bg-green-50 rounded-lg">
                                <div className="text-sm text-gray-600">æœˆå¹³å‡</div>
                                <div className="text-3xl font-bold text-green-600">
                                    Â¥{Math.round(recent12Avg).toLocaleString()}
                                </div>
                            </div>
                        </div>
                        <RecentMonthsChart data={recent12} />
                    </div>
                </div>
            );
        };

        // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¿ãƒ–
        const TrendsTab = ({ monthlyData, periodFilter, setPeriodFilter, selectedYear, setSelectedYear, filteredData }) => {
            const years = [...new Set(monthlyData.map(d => d.year))];

            return (
                <div>
                    {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
                    <div className="card mb-6">
                        <h3 className="text-xl font-bold mb-4">ğŸ“… æœŸé–“é¸æŠ</h3>
                        <div className="flex flex-wrap">
                            <button className={`filter-btn ${periodFilter === 'all' ? 'active' : ''}`}
                                onClick={() => setPeriodFilter('all')}>å…¨æœŸé–“</button>
                            <button className={`filter-btn ${periodFilter === 'recent' ? 'active' : ''}`}
                                onClick={() => setPeriodFilter('recent')}>ç›´è¿‘12ãƒ¶æœˆ</button>
                            <button className={`filter-btn ${periodFilter === 'year' ? 'active' : ''}`}
                                onClick={() => setPeriodFilter('year')}>å¹´åˆ¥</button>
                            
                            {periodFilter === 'year' && (
                                <select value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)}
                                    className="ml-4 p-2 border-2 border-gray-300 rounded-lg">
                                    {years.map(year => (
                                        <option key={year} value={year}>{year}å¹´</option>
                                    ))}
                                </select>
                            )}
                        </div>
                    </div>

                    {/* ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆ */}
                    <MonthlyTrendChart data={filteredData} />
                </div>
            );
        };

        // å†…è¨³ã‚¿ãƒ–
        const BreakdownTab = ({ shopData, categoryData }) => {
            return (
                <div className="grid lg:grid-cols-2 gap-6">
                    <ShopBreakdownCard data={shopData} />
                    <CategoryBreakdownCard data={categoryData} />
                </div>
            );
        };

        // åˆ†æã‚¿ãƒ–
        const InsightsTab = ({ monthlyData, statsData }) => {
            return (
                <div>
                    <InsightCards monthlyData={monthlyData} />
                    {statsData && (
                        <>
                            <WeekdayAnalysis data={statsData.weekday} />
                            <SeasonalAnalysis data={statsData.seasonal} />
                        </>
                    )}
                </div>
            );
        };

        // ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç¾¤
        const YearlyTrendChart = ({ yearlyData }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!yearlyData.length || !chartRef.current) return;

                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'bar',
                    data: {
                        labels: yearlyData.map(d => d.year),
                        datasets: [{
                            label: 'å¹´é–“æ”¯å‡º',
                            data: yearlyData.map(d => d.total_expense),
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'å¹´åˆ¥æ”¯å‡ºæ¨ç§»ï¼ˆ2008-2025ï¼‰', font: { size: 16 } }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'Â¥' + (value / 1000000).toFixed(1) + 'M'
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [yearlyData]);

            return (
                <div className="card mb-6">
                    <div style={{ height: '400px' }}>
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };

        const RecentMonthsChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!data.length || !chartRef.current) return;

                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.month),
                        datasets: [{
                            label: 'æœˆæ¬¡æ”¯å‡º',
                            data: data.map(d => d.expense),
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'Â¥' + (value / 1000).toFixed(0) + 'K'
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data]);

            return (
                <div style={{ height: '300px' }}>
                    <canvas ref={chartRef}></canvas>
                </div>
            );
        };

        const MonthlyTrendChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!data.length || !chartRef.current) return;

                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                const expenses = data.map(d => d.expense);
                const movingAvg = expenses.map((_, idx, arr) => {
                    if (idx < 5) return null;
                    const slice = arr.slice(idx - 5, idx + 1);
                    return slice.reduce((sum, val) => sum + val, 0) / 6;
                });

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.month),
                        datasets: [
                            {
                                label: 'å®Ÿéš›ã®æ”¯å‡º',
                                data: expenses,
                                borderColor: 'rgba(239, 68, 68, 0.6)',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                pointRadius: 0,
                                borderWidth: 1
                            },
                            {
                                label: '6ãƒ¶æœˆç§»å‹•å¹³å‡',
                                data: movingAvg,
                                borderColor: 'rgb(34, 197, 94)',
                                borderWidth: 3,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'æ”¯å‡ºãƒˆãƒ¬ãƒ³ãƒ‰ã¨ç§»å‹•å¹³å‡', font: { size: 16 } }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'Â¥' + (value / 1000).toFixed(0) + 'K'
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data]);

            return (
                <div className="card">
                    <div style={{ height: '450px' }}>
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };

        const ShopBreakdownCard = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!data.length || !chartRef.current) return;

                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(d => d.shop_name),
                        datasets: [{
                            data: data.map(d => d.total),
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#36A2EB'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' },
                            title: { display: true, text: 'ã‚·ãƒ§ãƒƒãƒ—åˆ¥æ”¯å‡ºå‰²åˆ', font: { size: 16 } },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: Â¥${context.parsed.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data]);

            const total = data.reduce((sum, d) => sum + d.total, 0);

            return (
                <div className="card">
                    <div style={{ height: '400px' }}>
                        <canvas ref={chartRef}></canvas>
                    </div>
                    <div className="mt-6 space-y-2">
                        <h4 className="font-bold text-lg mb-3">ãƒˆãƒƒãƒ—5åº—èˆ—</h4>
                        {data.slice(0, 5).map((shop, idx) => (
                            <div key={idx} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span className="font-semibold">{shop.shop_name}</span>
                                <span className="text-blue-600">
                                    Â¥{shop.total.toLocaleString()} 
                                    <span className="text-sm text-gray-500 ml-2">
                                        ({((shop.total / total) * 100).toFixed(1)}%)
                                    </span>
                                </span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const CategoryBreakdownCard = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!data.length || !chartRef.current) return;

                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'bar',
                    data: {
                        labels: data.slice(0, 10).map(d => d.category_name),
                        datasets: [{
                            label: 'æ”¯å‡ºé¡',
                            data: data.slice(0, 10).map(d => d.total),
                            backgroundColor: 'rgba(139, 92, 246, 0.8)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡ºãƒ©ãƒ³ã‚­ãƒ³ã‚°', font: { size: 16 } }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'Â¥' + (value / 1000).toFixed(0) + 'K'
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data]);

            return (
                <div className="card">
                    <div style={{ height: '400px' }}>
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };

        const InsightCards = ({ monthlyData }) => {
            if (!monthlyData.length) return null;

            const recent6 = monthlyData.slice(-6);
            const previous6 = monthlyData.slice(-12, -6);
            const recentAvg = recent6.reduce((sum, d) => sum + d.expense, 0) / 6;
            const previousAvg = previous6.reduce((sum, d) => sum + d.expense, 0) / 6;
            const change = ((recentAvg - previousAvg) / previousAvg) * 100;

            const insights = [];
            if (Math.abs(change) > 5) {
                insights.push({
                    type: change > 0 ? 'warning' : 'success',
                    title: change > 0 ? 'âš ï¸ æ”¯å‡ºå¢—åŠ ãƒˆãƒ¬ãƒ³ãƒ‰' : 'âœ… æ”¯å‡ºå‰Šæ¸›æˆåŠŸ',
                    message: `éå»6ãƒ¶æœˆã®å¹³å‡æ”¯å‡ºãŒå‰ã®6ãƒ¶æœˆæ¯”ã§${Math.abs(change).toFixed(1)}%${change > 0 ? 'å¢—åŠ ' : 'æ¸›å°‘'}ã—ã¦ã„ã¾ã™ã€‚`
                });
            }

            const maxMonth = monthlyData.reduce((max, d) => d.expense > max.expense ? d : max);
            insights.push({
                type: 'info',
                title: 'ğŸ“Š æœ€é«˜æ”¯å‡ºæœˆ',
                message: `${maxMonth.month}ã«Â¥${maxMonth.expense.toLocaleString()}ã®æ”¯å‡ºï¼ˆéå»æœ€é«˜ï¼‰`
            });

            return (
                <div className="grid md:grid-cols-2 gap-6 mb-6">
                    {insights.map((insight, idx) => (
                        <div key={idx} className="card" style={{
                            background: insight.type === 'warning' ? 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' :
                                       insight.type === 'success' ? 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)' :
                                       'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                            color: insight.type === 'success' || insight.type === 'warning' ? '#333' : 'white'
                        }}>
                            <h4 className="text-xl font-bold mb-2">{insight.title}</h4>
                            <p className="text-lg">{insight.message}</p>
                        </div>
                    ))}
                </div>
            );
        };

        const WeekdayAnalysis = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!data.length || !chartRef.current) return;

                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                const dayLabels = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'bar',
                    data: {
                        labels: data.map((d, idx) => dayLabels[idx]),
                        datasets: [{
                            label: 'å¹³å‡æ”¯å‡º',
                            data: data.map(d => d.avg_expense),
                            backgroundColor: 'rgba(245, 158, 11, 0.8)',
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'æ›œæ—¥åˆ¥å¹³å‡æ”¯å‡º', font: { size: 16 } }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'Â¥' + (value / 1000).toFixed(0) + 'K'
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data]);

            return (
                <div className="card mb-6">
                    <div style={{ height: '300px' }}>
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };

        const SeasonalAnalysis = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!data.length || !chartRef.current) return;

                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                const monthLabels = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'line',
                    data: {
                        labels: monthLabels,
                        datasets: [{
                            label: 'æœˆåˆ¥å¹³å‡æ”¯å‡º',
                            data: data.map(d => d.avg_expense),
                            borderColor: 'rgb(236, 72, 153)',
                            backgroundColor: 'rgba(236, 72, 153, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'å­£ç¯€æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ', font: { size: 16 } }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'Â¥' + (value / 1000).toFixed(0) + 'K'
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data]);

            return (
                <div className="card">
                    <div style={{ height: '350px' }}>
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };

        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        ReactDOM.render(<FinanceAnalyticsDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
