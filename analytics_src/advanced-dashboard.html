<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶è¨ˆç°¿é«˜åº¦åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
            color: #64748b;
        }
        .tab-btn:hover {
            color: #667eea;
        }
        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .insight-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .warning-card {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .success-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // åˆ†æãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        const AnalysisHelpers = {
            // ç§»å‹•å¹³å‡è¨ˆç®—
            calculateMovingAverage: (data, window = 3) => {
                return data.map((_, idx, arr) => {
                    if (idx < window - 1) return null;
                    const slice = arr.slice(idx - window + 1, idx + 1);
                    return slice.reduce((sum, val) => sum + val, 0) / window;
                });
            },

            // å­£ç¯€æ€§æ¤œå‡º
            detectSeasonality: (monthlyData) => {
                const seasonalPattern = {};
                monthlyData.forEach(m => {
                    if (!seasonalPattern[m.month]) {
                        seasonalPattern[m.month] = [];
                    }
                    seasonalPattern[m.month].push(m.expense);
                });

                const seasonal = Object.keys(seasonalPattern).map(month => ({
                    month: parseInt(month),
                    avgExpense: seasonalPattern[month].reduce((a, b) => a + b) / seasonalPattern[month].length,
                    years: seasonalPattern[month].length
                }));

                return seasonal.sort((a, b) => a.month - b.month);
            },

            // ç•°å¸¸å€¤æ¤œå‡º
            detectAnomalies: (data, threshold = 2) => {
                const values = data.map(d => d.expense);
                const mean = values.reduce((a, b) => a + b) / values.length;
                const stdDev = Math.sqrt(
                    values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length
                );

                return data.filter(d => 
                    Math.abs(d.expense - mean) > threshold * stdDev
                ).map(d => ({
                    ...d,
                    deviation: ((d.expense - mean) / stdDev).toFixed(2)
                }));
            },

            // æ”¯å‡ºäºˆæ¸¬ï¼ˆç·šå½¢å›å¸°ï¼‰
            predictExpense: (monthlyData, months = 3) => {
                const n = monthlyData.length;
                const x = Array.from({length: n}, (_, i) => i);
                const y = monthlyData.map(d => d.expense);

                const sumX = x.reduce((a, b) => a + b);
                const sumY = y.reduce((a, b) => a + b);
                const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
                const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);

                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;

                const predictions = [];
                for (let i = 0; i < months; i++) {
                    const futureX = n + i;
                    predictions.push({
                        month: futureX,
                        predicted: Math.round(slope * futureX + intercept)
                    });
                }

                return predictions;
            },

            // ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
            analyzeTrend: (data) => {
                if (data.length < 2) return { direction: 'stable', change: 0 };
                
                const recent = data.slice(-6);
                const older = data.slice(-12, -6);
                
                const recentAvg = recent.reduce((sum, d) => sum + d.expense, 0) / recent.length;
                const olderAvg = older.reduce((sum, d) => sum + d.expense, 0) / older.length;
                
                const change = ((recentAvg - olderAvg) / olderAvg) * 100;
                
                return {
                    direction: change > 5 ? 'increasing' : change < -5 ? 'decreasing' : 'stable',
                    change: change.toFixed(1),
                    recentAvg,
                    olderAvg
                };
            }
        };

        // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        const AdvancedFinanceDashboard = () => {
            const [activeTab, setActiveTab] = useState('overview');
            const [data, setData] = useState(null);
            const [insights, setInsights] = useState([]);

            useEffect(() => {
                // ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆå®Ÿéš›ã¯APIçµŒç”±ï¼‰
                const generateData = () => {
                    const months = [];
                    for (let year = 2008; year <= 2025; year++) {
                        const monthsInYear = year === 2025 ? 10 : 12;
                        for (let month = 1; month <= monthsInYear; month++) {
                            const baseExpense = 200000;
                            const trend = (year - 2008) * 5000;
                            const seasonal = Math.sin((month - 1) / 12 * Math.PI * 2) * 20000;
                            const random = (Math.random() - 0.5) * 30000;
                            
                            months.push({
                                date: `${year}-${String(month).padStart(2, '0')}`,
                                year,
                                month,
                                income: 250000 + trend + random * 0.5,
                                expense: baseExpense + trend + seasonal + random
                            });
                        }
                    }
                    return months;
                };

                const monthlyData = generateData();
                setData(monthlyData);

                // ã‚¤ãƒ³ã‚µã‚¤ãƒˆç”Ÿæˆ
                generateInsights(monthlyData);
            }, []);

            const generateInsights = (monthlyData) => {
                const newInsights = [];

                // ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
                const trend = AnalysisHelpers.analyzeTrend(monthlyData);
                if (trend.direction === 'increasing') {
                    newInsights.push({
                        type: 'warning',
                        title: 'âš ï¸ æ”¯å‡ºå¢—åŠ ãƒˆãƒ¬ãƒ³ãƒ‰æ¤œå‡º',
                        message: `éå»6ãƒ¶æœˆã®å¹³å‡æ”¯å‡ºãŒå‰ã®6ãƒ¶æœˆã¨æ¯”ã¹ã¦${trend.change}%å¢—åŠ ã—ã¦ã„ã¾ã™ã€‚`
                    });
                } else if (trend.direction === 'decreasing') {
                    newInsights.push({
                        type: 'success',
                        title: 'âœ… æ”¯å‡ºå‰Šæ¸›æˆåŠŸ',
                        message: `éå»6ãƒ¶æœˆã®å¹³å‡æ”¯å‡ºãŒå‰ã®6ãƒ¶æœˆã¨æ¯”ã¹ã¦${Math.abs(trend.change)}%æ¸›å°‘ã—ã¦ã„ã¾ã™ï¼`
                    });
                }

                // ç•°å¸¸å€¤æ¤œå‡º
                const anomalies = AnalysisHelpers.detectAnomalies(monthlyData.slice(-12));
                if (anomalies.length > 0) {
                    newInsights.push({
                        type: 'info',
                        title: 'ğŸ” ç•°å¸¸ãªæ”¯å‡ºã‚’æ¤œå‡º',
                        message: `éå»12ãƒ¶æœˆã§${anomalies.length}ä»¶ã®é€šå¸¸ã¨ç•°ãªã‚‹æ”¯å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`
                    });
                }

                // å­£ç¯€æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³
                const seasonal = AnalysisHelpers.detectSeasonality(monthlyData);
                const maxMonth = seasonal.reduce((max, s) => s.avgExpense > max.avgExpense ? s : max);
                newInsights.push({
                    type: 'info',
                    title: 'ğŸ“Š å­£ç¯€æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³',
                    message: `${maxMonth.month}æœˆã¯å¹³å‡çš„ã«æ”¯å‡ºãŒå¤šã„å‚¾å‘ãŒã‚ã‚Šã¾ã™ï¼ˆå¹³å‡Â¥${Math.round(maxMonth.avgExpense).toLocaleString()}ï¼‰`
                });

                setInsights(newInsights);
            };

            if (!data) return <div className="text-white text-center">Loading...</div>;

            return (
                <div className="max-w-7xl mx-auto">
                    <h1 className="text-4xl font-bold text-white text-center mb-8">
                        ğŸš€ é«˜åº¦åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                    </h1>

                    {/* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
                    <div className="card mb-6">
                        <div className="flex overflow-x-auto">
                            <button 
                                className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
                                onClick={() => setActiveTab('overview')}
                            >
                                ğŸ“Š æ¦‚è¦
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'trends' ? 'active' : ''}`}
                                onClick={() => setActiveTab('trends')}
                            >
                                ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'predictions' ? 'active' : ''}`}
                                onClick={() => setActiveTab('predictions')}
                            >
                                ğŸ”® äºˆæ¸¬
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'insights' ? 'active' : ''}`}
                                onClick={() => setActiveTab('insights')}
                            >
                                ğŸ’¡ ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
                            </button>
                            <button 
                                className={`tab-btn ${activeTab === 'anomalies' ? 'active' : ''}`}
                                onClick={() => setActiveTab('anomalies')}
                            >
                                ğŸ” ç•°å¸¸æ¤œçŸ¥
                            </button>
                        </div>
                    </div>

                    {/* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
                    {activeTab === 'overview' && <OverviewTab data={data} />}
                    {activeTab === 'trends' && <TrendsTab data={data} />}
                    {activeTab === 'predictions' && <PredictionsTab data={data} />}
                    {activeTab === 'insights' && <InsightsTab insights={insights} data={data} />}
                    {activeTab === 'anomalies' && <AnomaliesTab data={data} />}
                </div>
            );
        };

        // æ¦‚è¦ã‚¿ãƒ–
        const OverviewTab = ({ data }) => {
            const recent12 = data.slice(-12);
            const totalIncome = recent12.reduce((sum, m) => sum + m.income, 0);
            const totalExpense = recent12.reduce((sum, m) => sum + m.expense, 0);
            const savingsRate = ((totalIncome - totalExpense) / totalIncome) * 100;

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="card text-center">
                        <h3 className="text-lg font-semibold text-gray-600">ç›´è¿‘12ãƒ¶æœˆ ç·åå…¥</h3>
                        <div className="text-4xl font-bold text-green-600 my-4">
                            Â¥{(totalIncome / 1000000).toFixed(2)}M
                        </div>
                        <p className="text-sm text-gray-500">æœˆå¹³å‡: Â¥{Math.round(totalIncome / 12).toLocaleString()}</p>
                    </div>
                    <div className="card text-center">
                        <h3 className="text-lg font-semibold text-gray-600">ç›´è¿‘12ãƒ¶æœˆ ç·æ”¯å‡º</h3>
                        <div className="text-4xl font-bold text-red-600 my-4">
                            Â¥{(totalExpense / 1000000).toFixed(2)}M
                        </div>
                        <p className="text-sm text-gray-500">æœˆå¹³å‡: Â¥{Math.round(totalExpense / 12).toLocaleString()}</p>
                    </div>
                    <div className="card text-center">
                        <h3 className="text-lg font-semibold text-gray-600">è²¯è“„ç‡</h3>
                        <div className="text-4xl font-bold text-blue-600 my-4">
                            {savingsRate.toFixed(1)}%
                        </div>
                        <p className="text-sm text-gray-500">å¹´é–“è²¯è“„: Â¥{Math.round((totalIncome - totalExpense) / 1000).toLocaleString()}K</p>
                    </div>
                </div>
            );
        };

        // ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚¿ãƒ–
        const TrendsTab = ({ data }) => {
            const chartRef = useRef(null);
            const chart = useRef(null);

            useEffect(() => {
                if (chartRef.current) {
                    if (chart.current) chart.current.destroy();

                    const expenses = data.map(d => d.expense);
                    const movingAvg = AnalysisHelpers.calculateMovingAverage(expenses, 6);

                    chart.current = new Chart(chartRef.current, {
                        type: 'line',
                        data: {
                            labels: data.map(d => d.date),
                            datasets: [
                                {
                                    label: 'å®Ÿéš›ã®æ”¯å‡º',
                                    data: expenses,
                                    borderColor: 'rgba(255, 99, 132, 0.5)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    pointRadius: 0
                                },
                                {
                                    label: '6ãƒ¶æœˆç§»å‹•å¹³å‡',
                                    data: movingAvg,
                                    borderColor: 'rgb(75, 192, 192)',
                                    borderWidth: 3,
                                    pointRadius: 0
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'æ”¯å‡ºãƒˆãƒ¬ãƒ³ãƒ‰ã¨ç§»å‹•å¹³å‡' }
                            }
                        }
                    });
                }
            }, [data]);

            return (
                <div className="card">
                    <div style={{ height: '500px' }}>
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };

        // äºˆæ¸¬ã‚¿ãƒ–
        const PredictionsTab = ({ data }) => {
            const predictions = AnalysisHelpers.predictExpense(data, 6);
            
            return (
                <div className="card">
                    <h3 className="text-2xl font-bold mb-4">ğŸ“Š ä»Šå¾Œ6ãƒ¶æœˆã®æ”¯å‡ºäºˆæ¸¬</h3>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                        {predictions.map((pred, idx) => (
                            <div key={idx} className="p-4 bg-gradient-to-r from-purple-400 to-pink-400 rounded-lg text-white">
                                <div className="text-sm opacity-90">+{idx + 1}ãƒ¶æœˆå¾Œ</div>
                                <div className="text-2xl font-bold">Â¥{pred.predicted.toLocaleString()}</div>
                            </div>
                        ))}
                    </div>
                    <p className="mt-6 text-sm text-gray-600">
                        â€» ç·šå½¢å›å¸°ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹äºˆæ¸¬ã€‚éå»ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚
                    </p>
                </div>
            );
        };

        // ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚¿ãƒ–
        const InsightsTab = ({ insights, data }) => {
            const seasonal = AnalysisHelpers.detectSeasonality(data);
            
            return (
                <div>
                    {insights.map((insight, idx) => (
                        <div 
                            key={idx} 
                            className={insight.type === 'warning' ? 'warning-card' : insight.type === 'success' ? 'success-card' : 'insight-card'}
                        >
                            <h4 className="text-lg font-bold mb-2">{insight.title}</h4>
                            <p>{insight.message}</p>
                        </div>
                    ))}

                    <div className="card mt-6">
                        <h3 className="text-xl font-bold mb-4">æœˆåˆ¥å¹³å‡æ”¯å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
                        <div className="grid grid-cols-3 md:grid-cols-4 gap-3">
                            {seasonal.map(s => (
                                <div key={s.month} className="p-3 bg-gray-100 rounded-lg text-center">
                                    <div className="text-sm font-semibold">{s.month}æœˆ</div>
                                    <div className="text-lg">Â¥{Math.round(s.avgExpense / 1000)}K</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // ç•°å¸¸æ¤œçŸ¥ã‚¿ãƒ–
        const AnomaliesTab = ({ data }) => {
            const anomalies = AnalysisHelpers.detectAnomalies(data.slice(-24));
            
            return (
                <div className="card">
                    <h3 className="text-2xl font-bold mb-4">ğŸ” éå»24ãƒ¶æœˆã®ç•°å¸¸å€¤</h3>
                    {anomalies.length === 0 ? (
                        <p className="text-gray-600">ç•°å¸¸ãªæ”¯å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                    ) : (
                        <div className="space-y-3">
                            {anomalies.map((anomaly, idx) => (
                                <div key={idx} className="p-4 border-l-4 border-red-500 bg-red-50 rounded">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <div className="font-bold">{anomaly.date}</div>
                                            <div className="text-sm text-gray-600">
                                                æ¨™æº–åå·®: {anomaly.deviation}Ïƒ
                                            </div>
                                        </div>
                                        <div className="text-2xl font-bold text-red-600">
                                            Â¥{Math.round(anomaly.expense).toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<AdvancedFinanceDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
