name: Database Tests

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  schema-validation:
    name: MySQL Schema Validation
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: pfd_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for MySQL
        run: |
          until mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_password --silent; do
            echo 'Waiting for MySQL...'
            sleep 2
          done
          echo "âœ… MySQL is ready!"

      - name: Validate schema.sql syntax
        run: |
          echo "Validating SQL syntax..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_test --verbose < schema.sql

      - name: Check database structure
        run: |
          echo "Checking created tables..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_test -e "SHOW TABLES;"

          echo "Checking users table structure..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_test -e "DESCRIBE users;"

          echo "Checking source table structure..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_test -e "DESCRIBE source;"

          echo "Checking cat_1_labels table structure..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_test -e "DESCRIBE cat_1_labels;"

          echo "Checking cat_2_labels table structure..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_test -e "DESCRIBE cat_2_labels;"

      - name: Verify indexes
        run: |
          echo "Checking indexes on source table..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_test -e "SHOW INDEX FROM source;"

      - name: Test basic queries
        run: |
          echo "Testing basic SELECT queries..."

          # Test user query
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_test -e "SELECT * FROM users;"

          # Test JOIN query (similar to application queries)
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_test -e "
            SELECT
              s.id,
              s.re_date,
              c1.label AS label1,
              c2.label AS label2,
              s.price
            FROM source s
            LEFT JOIN cat_1_labels c1 ON s.cat_1 = c1.id AND s.user_id = c1.user_id
            LEFT JOIN cat_2_labels c2 ON s.cat_2 = c2.id AND s.user_id = c2.user_id
            WHERE s.user_id = 1
            ORDER BY s.re_date DESC
            LIMIT 10;
          "

      - name: Test constraints
        run: |
          echo "Testing UNIQUE constraints..."

          # Try to insert duplicate user with same (user_id, label)
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_test << 'EOF' || echo "âœ… UNIQUE constraint working"
            INSERT INTO cat_1_labels (user_id, label) VALUES (1, 'Test Store');
            INSERT INTO cat_1_labels (user_id, label) VALUES (1, 'Test Store');
          EOF

      - name: Test foreign key behavior
        run: |
          echo "Testing foreign key relationships..."

          # Insert test data
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_test << 'EOF'
            INSERT INTO cat_1_labels (user_id, label) VALUES (1, 'FK Test Store');
            INSERT INTO cat_2_labels (user_id, label) VALUES (1, 'FK Test Category');

            SET @cat1_id = LAST_INSERT_ID();

            INSERT INTO source (user_id, re_date, cat_1, cat_2, price)
            VALUES (1, '2025-01-01', @cat1_id, @cat1_id, 1000);

            SELECT * FROM source WHERE user_id = 1;
          EOF

          echo "âœ… Foreign key relationships working"

  migration-test:
    name: Database Migration Test
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: pfd_migration_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for MySQL
        run: |
          until mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_password --silent; do
            echo 'Waiting for MySQL...'
            sleep 2
          done

      - name: Test schema with MySQL 8.0
        run: |
          echo "Testing schema compatibility with MySQL 8.0..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_migration_test < schema.sql
          echo "âœ… Schema is compatible with MySQL 8.0"

      - name: Verify utf8mb4 encoding
        run: |
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_migration_test -e "
            SHOW VARIABLES LIKE 'character_set%';
            SHOW VARIABLES LIKE 'collation%';
          "

          echo "Testing emoji support..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_migration_test << 'EOF'
            INSERT INTO cat_1_labels (user_id, label) VALUES (1, 'Test ðŸª Store');
            SELECT label FROM cat_1_labels WHERE user_id = 1;
          EOF
          echo "âœ… UTF8MB4 encoding working correctly"
