name: Continuous Integration

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  multi-php-test:
    name: Test PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        php-version: ['7.4', '8.0', '8.1', '8.2', '8.3']
        mysql-version: ['5.7', '8.0']
        exclude:
          # Optimize by testing only key combinations
          - php-version: '7.4'
            mysql-version: '8.0'
          - php-version: '8.0'
            mysql-version: '8.0'
          - php-version: '8.1'
            mysql-version: '5.7'
          - php-version: '8.2'
            mysql-version: '5.7'

    services:
      mysql:
        image: mysql:${{ matrix.mysql-version }}
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: pfd_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: pdo, pdo_mysql, mbstring, intl
          ini-values: error_reporting=E_ALL, display_errors=On
          coverage: none

      - name: Display PHP version
        run: php -v

      - name: Display PHP configuration
        run: php -i | grep -E "pdo|mysql|mbstring"

      - name: Check PHP syntax
        run: |
          echo "Checking PHP syntax with PHP ${{ matrix.php-version }}..."
          HAS_ERRORS=0
          while IFS= read -r -d '' file; do
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "‚ùå Syntax error in: $file"
              php -l "$file"
              HAS_ERRORS=1
            fi
          done < <(find . -name "*.php" -not -path "./vendor/*" -print0)

          if [ $HAS_ERRORS -eq 1 ]; then
            exit 1
          fi
          echo "‚úÖ All PHP files have valid syntax!"

      - name: Wait for MySQL
        run: |
          until mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_password --silent; do
            echo 'Waiting for MySQL...'
            sleep 2
          done

      - name: Import database schema
        run: |
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password pfd_test < schema.sql

      - name: Test database connectivity
        run: |
          php -r "
            try {
              \$pdo = new PDO(
                'mysql:host=127.0.0.1;dbname=pfd_test;charset=utf8mb4',
                'root',
                'root_password',
                [
                  PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                  PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                  PDO::ATTR_EMULATE_PREPARES => false
                ]
              );
              echo '‚úÖ Database connection successful with PHP ' . PHP_VERSION . PHP_EOL;

              // Test query
              \$stmt = \$pdo->query('SELECT COUNT(*) as count FROM users');
              \$result = \$stmt->fetch();
              echo '‚úÖ Query test successful. Users count: ' . \$result['count'] . PHP_EOL;
            } catch (PDOException \$e) {
              echo '‚ùå Database connection failed: ' . \$e->getMessage() . PHP_EOL;
              exit(1);
            }
          "

      - name: Test PDO prepared statements
        run: |
          php -r "
            try {
              \$pdo = new PDO(
                'mysql:host=127.0.0.1;dbname=pfd_test;charset=utf8mb4',
                'root',
                'root_password',
                [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]
              );

              // Test prepared statement
              \$stmt = \$pdo->prepare('SELECT * FROM users WHERE id = :id');
              \$stmt->bindValue(':id', 1, PDO::PARAM_INT);
              \$stmt->execute();
              \$user = \$stmt->fetch(PDO::FETCH_ASSOC);

              if (\$user) {
                echo '‚úÖ Prepared statement test successful' . PHP_EOL;
              } else {
                echo '‚ö†Ô∏è  No user found with id=1' . PHP_EOL;
              }
            } catch (PDOException \$e) {
              echo '‚ùå Prepared statement test failed: ' . \$e->getMessage() . PHP_EOL;
              exit(1);
            }
          "

  compatibility-check:
    name: Compatibility Matrix
    runs-on: ubuntu-latest
    needs: multi-php-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate compatibility report
        run: |
          echo "## üéØ Compatibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ All PHP versions passed syntax and database connectivity tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tested Configurations:" >> $GITHUB_STEP_SUMMARY
          echo "- PHP 7.4 + MySQL 5.7" >> $GITHUB_STEP_SUMMARY
          echo "- PHP 8.0 + MySQL 5.7" >> $GITHUB_STEP_SUMMARY
          echo "- PHP 8.1 + MySQL 8.0" >> $GITHUB_STEP_SUMMARY
          echo "- PHP 8.2 + MySQL 8.0" >> $GITHUB_STEP_SUMMARY
          echo "- PHP 8.3 + MySQL 8.0" >> $GITHUB_STEP_SUMMARY

  build-test:
    name: Build and Integration Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          extensions: pdo, pdo_mysql, mbstring

      - name: Validate file structure
        run: |
          echo "Validating project structure..."

          # Check critical files exist
          test -f includes/config.php && echo "‚úÖ config.php exists" || exit 1
          test -f schema.sql && echo "‚úÖ schema.sql exists" || exit 1
          test -f index.php && echo "‚úÖ index.php exists" || exit 1

          # Check directory structure
          test -d pages && echo "‚úÖ pages/ directory exists" || exit 1
          test -d assets && echo "‚úÖ assets/ directory exists" || exit 1
          test -d includes && echo "‚úÖ includes/ directory exists" || exit 1

      - name: Check for common issues
        run: |
          echo "Checking for common PHP issues..."

          # Check for short tags
          if grep -r "<?" --include="*.php" . | grep -v "<?php" | grep -v "<?xml"; then
            echo "‚ö†Ô∏è  Found short PHP tags - consider using full <?php tags"
          else
            echo "‚úÖ No short PHP tags found"
          fi

          # Check for eval()
          if grep -r "eval(" --include="*.php" .; then
            echo "‚ö†Ô∏è  Found eval() usage - potential security risk"
          else
            echo "‚úÖ No eval() usage found"
          fi

          # Check for hardcoded credentials
          if grep -ri "password\s*=\s*['\"][^'\"]*['\"]" --include="*.php" . | grep -v "MYSQL_PASSWORD" | grep -v "test_password" | grep -v ":password"; then
            echo "‚ö†Ô∏è  Found potential hardcoded passwords"
          else
            echo "‚úÖ No hardcoded passwords found"
          fi
