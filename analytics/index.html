<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Advanced Analytics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        body {
            background-color: #212529;
            color: #dee2e6;
            min-height: 100vh;
        }

        /* Light theme */
        [data-bs-theme="light"] body {
            background-color: #f8f9fa;
            color: #212529;
        }

        .stat-card {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12), 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 16px rgba(13,110,253,0.3), 0 4px 8px rgba(0,0,0,0.15);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .stat-sublabel {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .chart-container {
            background: #2b3035;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12), 0 1px 3px rgba(0,0,0,0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .chart-container:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 2px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        [data-bs-theme="light"] .chart-container {
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.04);
        }

        [data-bs-theme="light"] .chart-container:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.08);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        canvas {
            max-height: 400px;
        }

        .filter-section {
            background: #2b3035;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        [data-bs-theme="light"] .filter-section {
            background: white;
            border: 1px solid #dee2e6;
        }

        .navbar {
            margin-bottom: 1.5rem;
        }

        .data-table {
            font-size: 0.9rem;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: rgba(13, 110, 253, 0.15);
            font-weight: 600;
            border-bottom: 2px solid rgba(13, 110, 253, 0.3);
        }

        .data-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(13, 110, 253, 0.05);
        }

        [data-bs-theme="light"] .data-table tbody tr:hover {
            background: rgba(13, 110, 253, 0.08);
        }

        .trend-up {
            color: #dc3545;
        }

        .trend-down {
            color: #198754;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 2rem 0 1.5rem 0;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid #0d6efd;
            position: relative;
            display: inline-block;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #0d6efd, #0dcaf0);
            border-radius: 2px;
        }

        #root {
            min-height: 400px;
        }

        @media (max-width: 768px) {
            .stat-value {
                font-size: 1.5rem;
            }
            .chart-container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar (matching main dashboard) -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1" style="cursor: pointer;" onclick="window.location.href='../index.php';">
                <i class="bi bi-wallet2"></i>
                <span id="navTitle">Personal Finance Dashboard</span>
            </span>
            <div>
                <button class="btn btn-outline-light btn-sm me-2" id="langToggle">
                    <i class="bi bi-translate"></i> <span id="langLabel">JP</span>
                </button>
                <button class="btn btn-outline-light btn-sm me-2" id="themeToggle">
                    <i class="bi bi-moon-fill" id="themeIcon"></i>
                </button>
                <button onclick="window.close()" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-x-lg"></i> <span id="closeBtn">Close</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Loading/Error State -->
        <div id="root">
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3" id="loadingText">Loading data...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Version: 2024-10-27-v2 - Fixed number formatting with thousand separators
        console.log('Analytics Dashboard v2024-10-27-v2 loaded');

        const API_BASE_URL = '../api/analytics-api.php';

        // Translations
        const translations = {
            en: {
                navTitle: 'Personal Finance Dashboard',
                pageTitle: 'Advanced Analytics Dashboard',
                close: 'Close',
                loadingText: 'Loading data...',
                errorOccurred: 'An Error Occurred',
                noData: 'No Data Available',
                noDataMessage: 'No data found to display.',
                reload: 'Reload',
                totalExpense: 'Total Expense',
                avgMonthlyExpense: 'Avg Monthly Expense',
                totalTransactions: 'Total Transactions',
                uniqueShops: 'Unique Shops',
                period: 'Period',
                months: 'months',
                years: 'years',
                days: 'days',
                categories: 'categories',
                yearlyTrend: 'Yearly Expense Trend',
                monthlyTrend: 'Recent 12 Months Trend',
                shopBreakdown: 'Shop-wise Breakdown',
                categoryBreakdown: 'Category-wise Breakdown',
                weekdayAnalysis: 'Weekday Analysis',
                seasonalPattern: 'Seasonal Pattern',
                topShops: 'Top 10 Shops',
                topCategories: 'Top 10 Categories',
                statistics: 'Statistical Analysis',
                filters: 'Filters',
                selectPeriod: 'Select Period',
                customPeriod: 'Custom Period',
                allTime: 'All Time',
                last12Months: 'Last 12 Months',
                last6Months: 'Last 6 Months',
                thisYear: 'This Year',
                lastYear: 'Last Year',
                apply: 'Apply',
                reset: 'Reset',
                shop: 'Shop',
                category: 'Category',
                amount: 'Amount',
                transactions: 'Transactions',
                avgAmount: 'Avg Amount',
                percentage: 'Percentage',
                dayOfWeek: 'Day of Week',
                avgExpense: 'Avg Expense',
                month: 'Month',
                january: 'January',
                february: 'February',
                march: 'March',
                april: 'April',
                may: 'May',
                june: 'June',
                july: 'July',
                august: 'August',
                september: 'September',
                october: 'October',
                november: 'November',
                december: 'December',
                sunday: 'Sunday',
                monday: 'Monday',
                tuesday: 'Tuesday',
                wednesday: 'Wednesday',
                thursday: 'Thursday',
                friday: 'Friday',
                saturday: 'Saturday',
                vs6MonthsAgo: 'vs 6 months ago',
                vs12MonthsAgo: 'vs 12 months ago',
                vsLastMonth: 'vs last month',
                comparison: 'Comparison',
                avgAmountNote: 'Note: Avg Amount represents the monthly average per shop/category.',
                seasonalNote: 'Note: Seasonal pattern shows the average expense for each calendar month across all years in the dataset.'
            },
            ja: {
                navTitle: '家計簿ダッシュボード',
                pageTitle: '高度な分析ダッシュボード',
                close: '閉じる',
                loadingText: 'データを読み込んでいます...',
                errorOccurred: 'エラーが発生しました',
                noData: 'データがありません',
                noDataMessage: '表示するデータが見つかりませんでした。',
                reload: '再読み込み',
                totalExpense: '総支出額',
                avgMonthlyExpense: '月平均支出',
                totalTransactions: '総取引数',
                uniqueShops: '利用店舗数',
                period: '期間',
                months: 'ヶ月',
                years: '年',
                days: '日',
                categories: 'カテゴリ',
                yearlyTrend: '年別支出推移',
                monthlyTrend: '直近12ヶ月の推移',
                shopBreakdown: 'ショップ別内訳',
                categoryBreakdown: 'カテゴリ別内訳',
                weekdayAnalysis: '曜日別分析',
                seasonalPattern: '季節性パターン',
                topShops: 'トップ10店舗',
                topCategories: 'トップ10カテゴリ',
                statistics: '統計分析',
                filters: 'フィルター',
                selectPeriod: '期間を選択',
                customPeriod: 'カスタム期間',
                allTime: '全期間',
                last12Months: '直近12ヶ月',
                last6Months: '直近6ヶ月',
                thisYear: '今年',
                lastYear: '去年',
                apply: '適用',
                reset: 'リセット',
                shop: 'ショップ',
                category: 'カテゴリ',
                amount: '金額',
                transactions: '取引数',
                avgAmount: '平均金額',
                percentage: '割合',
                dayOfWeek: '曜日',
                avgExpense: '平均支出',
                month: '月',
                january: '1月',
                february: '2月',
                march: '3月',
                april: '4月',
                may: '5月',
                june: '6月',
                july: '7月',
                august: '8月',
                september: '9月',
                october: '10月',
                november: '11月',
                december: '12月',
                sunday: '日曜日',
                monday: '月曜日',
                tuesday: '火曜日',
                wednesday: '水曜日',
                thursday: '木曜日',
                friday: '金曜日',
                saturday: '土曜日',
                vs6MonthsAgo: '6か月前比',
                vs12MonthsAgo: '12か月前比',
                vsLastMonth: '前月比',
                comparison: '比較',
                avgAmountNote: '※Avg Amountは店舗・カテゴリごとの月平均を表します。',
                seasonalNote: '※季節性パターンは、全年のデータから各月（1月〜12月）の平均支出を計算したものです。'
            }
        };

        let currentLang = 'en';
        let charts = {};
        let cachedData = null;

        // Chart.js defaults
        Chart.defaults.color = '#dee2e6';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';

        // Language toggle
        function switchLanguage(lang) {
            currentLang = lang;
            document.getElementById('langLabel').textContent = lang === 'en' ? 'JP' : 'EN';
            updateUILanguage();
            if (cachedData) {
                renderDashboard(cachedData);
            }
        }

        function updateUILanguage() {
            const t = translations[currentLang];
            document.getElementById('navTitle').textContent = t.navTitle;
            document.getElementById('closeBtn').textContent = t.close;
            document.getElementById('loadingText').textContent = t.loadingText;
        }

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-bs-theme', newTheme);
            document.getElementById('themeIcon').className = newTheme === 'dark' ? 'bi bi-moon-fill' : 'bi bi-sun-fill';

            // Update Chart.js theme
            updateChartTheme(newTheme);

            // Re-render charts if data exists
            if (cachedData) {
                renderAllCharts(cachedData);
            }
        }

        function updateChartTheme(theme) {
            const textColor = theme === 'dark' ? '#dee2e6' : '#212529';
            const gridColor = theme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';

            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
        }

        // API calls
        async function fetchData(action, params = {}) {
            try {
                const queryString = new URLSearchParams({ action, ...params }).toString();
                const response = await fetch(`${API_BASE_URL}?${queryString}`);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, error: error.message };
            }
        }

        // Number formatting
        function formatNumber(num) {
            // Handle null, undefined, or empty values
            if (num === null || num === undefined || num === '') return '0';

            // Remove any existing commas if it's a string
            const cleanValue = typeof num === 'string' ? num.replace(/,/g, '') : num;

            // Convert to number
            const value = parseFloat(cleanValue);

            // Check if it's a valid number
            if (isNaN(value) || !isFinite(value)) return '0';

            // Round and format with thousand separators
            return Math.round(value).toLocaleString('en-US');
        }

        function formatCurrency(num, unit = 'K') {
            if (unit === 'M') {
                return `${(num / 1000000).toFixed(1).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}M`;
            }
            if (unit === 'raw') {
                return num.toLocaleString();
            }
            return `${(num / 1000).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}K`;
        }

        // Comparison rendering
        function renderComparison(percentage, label) {
            if (percentage === undefined || percentage === null) return '';

            const isIncrease = percentage > 0;
            const icon = isIncrease ? '▲' : '▼';
            const colorClass = isIncrease ? 'trend-up' : 'trend-down';
            const absPercentage = Math.abs(percentage).toFixed(1);

            return `
                <div class="stat-sublabel mt-2 ${colorClass}">
                    ${icon} ${absPercentage}% ${label || ''}
                </div>
            `;
        }

        // Error display
        function showError(message) {
            const t = translations[currentLang];
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="text-center p-5">
                    <div class="alert alert-danger" role="alert">
                        <h4 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> ${t.errorOccurred}</h4>
                        <p>${message}</p>
                        <hr />
                        <button class="btn btn-primary mt-2" onclick="loadAllData()">${t.reload}</button>
                    </div>
                </div>
            `;
        }

        // No data display
        function showNoData() {
            const t = translations[currentLang];
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="text-center p-5">
                    <div class="alert alert-warning" role="alert">
                        <h4 class="alert-heading"><i class="bi bi-info-circle"></i> ${t.noData}</h4>
                        <p>${t.noDataMessage}</p>
                    </div>
                </div>
            `;
        }

        // Main dashboard render
        function renderDashboard(data) {
            cachedData = data;
            const { summary, monthlyData, yearlyData, shopData, categoryData, weekdayStats, seasonalStats } = data;
            const t = translations[currentLang];

            const root = document.getElementById('root');
            root.innerHTML = `
                <header class="text-center mb-4">
                    <h1 class="display-5"><i class="bi bi-graph-up-arrow"></i> ${t.pageTitle}</h1>
                    <p class="lead text-muted">
                        ${summary.period?.start || 'N/A'} ~ ${summary.period?.end || 'N/A'}
                        (${summary.period?.total_years || 0} ${t.years})
                    </p>
                </header>

                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card">
                            <div class="stat-label">${t.totalExpense}</div>
                            <div class="stat-value">${formatCurrency(summary.totals?.expense || 0, 'M')}</div>
                            <div class="stat-sublabel">${summary.period?.total_months || 0} ${t.months}</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card">
                            <div class="stat-label">${t.avgMonthlyExpense}</div>
                            <div class="stat-value">${formatCurrency(summary.averages?.monthly_expense || 0)}</div>
                            <div class="stat-sublabel">${summary.period?.total_years || 0} ${t.years} average</div>
                            ${renderComparison(summary.comparisons?.current_vs_last_month, t.vsLastMonth)}
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card">
                            <div class="stat-label">${t.totalTransactions}</div>
                            <div class="stat-value">${formatNumber(summary.totals?.transactions || 0)}</div>
                            <div class="stat-sublabel">${summary.totals?.active_days || 0} ${t.days}</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card">
                            <div class="stat-label">${t.uniqueShops}</div>
                            <div class="stat-value">${summary.diversity?.unique_shops || 0}</div>
                            <div class="stat-sublabel">${summary.diversity?.unique_categories || 0} ${t.categories}</div>
                        </div>
                    </div>
                </div>

                <!-- Comparison Cards -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h3 class="chart-title mb-3"><i class="bi bi-bar-chart"></i> ${t.comparison} - ${t.vs6MonthsAgo}</h3>
                            <div class="row">
                                <div class="col-6 text-center p-3 border-end">
                                    <div class="text-muted mb-2">6 ${t.months} ago</div>
                                    <div class="h4">${formatCurrency(summary.comparisons?.six_months_ago || 0)}</div>
                                </div>
                                <div class="col-6 text-center p-3">
                                    <div class="text-muted mb-2">Current</div>
                                    <div class="h4">${formatCurrency(summary.comparisons?.current_month || 0)}</div>
                                    ${renderComparison(summary.comparisons?.current_vs_six_months, t.vs6MonthsAgo)}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h3 class="chart-title mb-3"><i class="bi bi-bar-chart"></i> ${t.comparison} - ${t.vs12MonthsAgo}</h3>
                            <div class="row">
                                <div class="col-6 text-center p-3 border-end">
                                    <div class="text-muted mb-2">12 ${t.months} ago</div>
                                    <div class="h4">${formatCurrency(summary.comparisons?.twelve_months_ago || 0)}</div>
                                </div>
                                <div class="col-6 text-center p-3">
                                    <div class="text-muted mb-2">Current</div>
                                    <div class="h4">${formatCurrency(summary.comparisons?.current_month || 0)}</div>
                                    ${renderComparison(summary.comparisons?.current_vs_twelve_months, t.vs12MonthsAgo)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Charts -->
                <h2 class="section-title">${t.statistics}</h2>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">${t.yearlyTrend}</h3>
                            </div>
                            <canvas id="yearlyChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">${t.monthlyTrend}</h3>
                            </div>
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">${t.shopBreakdown}</h3>
                            </div>
                            <canvas id="shopChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">${t.categoryBreakdown}</h3>
                            </div>
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Advanced Analysis -->
                <h2 class="section-title">${t.weekdayAnalysis}</h2>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">${t.weekdayAnalysis}</h3>
                            </div>
                            <canvas id="weekdayChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">${t.seasonalPattern}</h3>
                            </div>
                            <canvas id="seasonalChart"></canvas>
                            <small class="text-muted d-block mt-2">${t.seasonalNote}</small>
                        </div>
                    </div>
                </div>

                <!-- Data Tables -->
                <h2 class="section-title">${t.topShops}</h2>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h3 class="chart-title mb-3">${t.topShops}</h3>
                            ${renderShopTable(shopData, t)}
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h3 class="chart-title mb-3">${t.topCategories}</h3>
                            ${renderCategoryTable(categoryData, t)}
                        </div>
                    </div>
                </div>
            `;

            // Render all charts
            renderAllCharts(data);
        }

        function renderShopTable(data, t) {
            if (!data || data.length === 0) return '<p class="text-muted">No data</p>';

            // Calculate total for percentage
            const total = data.reduce((sum, item) => sum + parseFloat(item.total), 0);

            let html = '<div class="table-responsive"><table class="table table-sm data-table">';
            html += `<thead><tr>
                <th>#</th>
                <th>${t.shop}</th>
                <th class="text-end">${t.amount}</th>
                <th class="text-end">${t.percentage}</th>
                <th class="text-end">${t.transactions}</th>
                <th class="text-end">${t.avgAmount}</th>
            </tr></thead><tbody>`;

            data.slice(0, 10).forEach((item, index) => {
                const percentage = total > 0 ? ((parseFloat(item.total) / total) * 100).toFixed(1) : 0;
                html += `<tr>
                    <td>${index + 1}</td>
                    <td>${item.shop_name || 'N/A'}</td>
                    <td class="text-end">${formatNumber(item.total)}</td>
                    <td class="text-end">${percentage}%</td>
                    <td class="text-end">${formatNumber(item.transaction_count)}</td>
                    <td class="text-end">${formatNumber(item.avg_amount)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            html += `<small class="text-muted ms-2">${t.avgAmountNote}</small>`;
            html += '</div>';
            return html;
        }

        function renderCategoryTable(data, t) {
            if (!data || data.length === 0) return '<p class="text-muted">No data</p>';

            let html = '<div class="table-responsive"><table class="table table-sm data-table">';
            html += `<thead><tr>
                <th>#</th>
                <th>${t.category}</th>
                <th class="text-end">${t.amount}</th>
                <th class="text-end">${t.transactions}</th>
                <th class="text-end">${t.avgAmount}</th>
            </tr></thead><tbody>`;

            data.slice(0, 10).forEach((item, index) => {
                html += `<tr>
                    <td>${index + 1}</td>
                    <td>${item.category_name || 'N/A'}</td>
                    <td class="text-end">${formatNumber(item.total)}</td>
                    <td class="text-end">${formatNumber(item.transaction_count)}</td>
                    <td class="text-end">${formatNumber(item.avg_amount)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            html += `<small class="text-muted ms-2">${t.avgAmountNote}</small>`;
            html += '</div>';
            return html;
        }

        function renderAllCharts(data) {
            const { yearlyData, monthlyData, shopData, categoryData, weekdayStats, seasonalStats } = data;

            console.log('Rendering charts with data:', {
                yearlyData: yearlyData?.length,
                monthlyData: monthlyData?.length,
                shopData: shopData?.length,
                categoryData: categoryData?.length,
                weekdayStats: weekdayStats?.length,
                seasonalStats: seasonalStats?.length
            });

            renderYearlyChart(yearlyData);
            renderMonthlyChart(monthlyData);
            renderShopChart(shopData);
            renderCategoryChart(categoryData);
            renderWeekdayChart(weekdayStats);
            renderSeasonalChart(seasonalStats);
        }

        function destroyChart(chartId) {
            if (charts[chartId]) {
                charts[chartId].destroy();
                charts[chartId] = null;
            }
        }

        function renderYearlyChart(data) {
            destroyChart('yearly');
            const canvas = document.getElementById('yearlyChart');
            if (!canvas || !data || !data.length) return;

            charts.yearly = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.year),
                    datasets: [{
                        label: translations[currentLang].totalExpense,
                        data: data.map(d => d.total_expense),
                        backgroundColor: 'rgba(13, 110, 253, 0.8)',
                        borderColor: 'rgba(13, 110, 253, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatNumber(context.parsed.y)
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: v => formatCurrency(v, 'M')
                            }
                        }
                    }
                }
            });
        }

        function renderMonthlyChart(data) {
            destroyChart('monthly');
            const canvas = document.getElementById('monthlyChart');
            if (!canvas || !data || !data.length) return;

            const recentData = data.slice(-12);

            charts.monthly = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: recentData.map(d => d.month),
                    datasets: [{
                        label: translations[currentLang].avgMonthlyExpense,
                        data: recentData.map(d => d.expense),
                        borderColor: 'rgb(13, 202, 240)',
                        backgroundColor: 'rgba(13, 202, 240, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${formatNumber(context.parsed.y)} /mo`
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: v => formatCurrency(v)
                            }
                        }
                    }
                }
            });
        }

        function renderShopChart(data) {
            destroyChart('shop');
            const canvas = document.getElementById('shopChart');
            if (!canvas || !data || !data.length) return;

            const topData = data.slice(0, 10);
            const total = topData.reduce((sum, d) => sum + parseFloat(d.total), 0);

            // Get current theme
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const legendTextColor = currentTheme === 'dark' ? '#dee2e6' : '#212529';

            charts.shop = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: topData.map(d => d.shop_name),
                    datasets: [{
                        data: topData.map(d => parseFloat(d.total)),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#36A2EB'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                font: { size: 11 },
                                color: legendTextColor,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return {
                                                text: `${label} ${percentage}%`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                fontColor: legendTextColor,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${formatNumber(value)} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                size: 13,
                                weight: 'bold'
                            },
                            formatter: (value, context) => {
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                // Only display percentage if it's >= 5% to avoid clutter
                                return percentage >= 5 ? `${percentage}%` : '';
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderCategoryChart(data) {
            destroyChart('category');
            const canvas = document.getElementById('categoryChart');
            if (!canvas || !data || !data.length) return;

            const topData = data.slice(0, 10);

            charts.category = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: topData.map(d => d.category_name),
                    datasets: [{
                        label: translations[currentLang].amount,
                        data: topData.map(d => d.total),
                        backgroundColor: 'rgba(111, 66, 193, 0.8)',
                        borderColor: 'rgba(111, 66, 193, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatNumber(context.parsed.x)
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#dee2e6',
                            font: {
                                size: 11,
                                weight: 'bold'
                            },
                            formatter: (value) => formatCurrency(value)
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: v => formatCurrency(v)
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderWeekdayChart(data) {
            console.log('Rendering weekday chart with data:', data);
            destroyChart('weekday');
            const canvas = document.getElementById('weekdayChart');
            if (!canvas) {
                console.error('Weekday chart canvas not found!');
                return;
            }
            if (!data || !data.length) {
                console.warn('No weekday data available');
                return;
            }

            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const t = translations[currentLang];

            // Sort by day_num (1=Sunday, 2=Monday, etc.)
            const sortedData = [...data].sort((a, b) => a.day_num - b.day_num);

            charts.weekday = new Chart(canvas, {
                type: 'bar',
                data: {
                    // Use day_num - 1 to get correct day name (day_num starts at 1)
                    labels: sortedData.map(d => t[dayNames[d.day_num - 1]] || d.day_of_week),
                    datasets: [{
                        label: t.avgExpense,
                        data: sortedData.map(d => d.avg_expense),
                        backgroundColor: 'rgba(255, 159, 64, 0.8)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1,
                        barPercentage: 0.9,
                        categoryPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${t.avgExpense}: ${formatNumber(context.parsed.y)} /day`
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                offset: false
                            },
                            ticks: {
                                autoSkip: false
                            }
                        },
                        y: {
                            ticks: {
                                callback: v => formatCurrency(v)
                            }
                        }
                    }
                }
            });
        }

        function renderSeasonalChart(data) {
            console.log('Rendering seasonal chart with data:', data);
            destroyChart('seasonal');
            const canvas = document.getElementById('seasonalChart');
            if (!canvas) {
                console.error('Seasonal chart canvas not found!');
                return;
            }
            if (!data || !data.length) {
                console.warn('No seasonal data available');
                return;
            }

            const monthNames = ['january', 'february', 'march', 'april', 'may', 'june',
                              'july', 'august', 'september', 'october', 'november', 'december'];
            const t = translations[currentLang];

            charts.seasonal = new Chart(canvas, {
                type: 'line',
                data: {
                    // Month is 1-12, so use month - 1 for array index
                    labels: data.map(d => t[monthNames[d.month - 1]] || d.month),
                    datasets: [{
                        label: t.avgExpense,
                        data: data.map(d => d.avg_expense),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${t.avgExpense}: ${formatNumber(context.parsed.y)} /mo`
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                offset: false
                            },
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 0
                            }
                        },
                        y: {
                            ticks: {
                                callback: v => formatCurrency(v)
                            }
                        }
                    }
                }
            });
        }

        // Load all data
        async function loadAllData() {
            try {
                console.log('Loading analytics data...');

                const [summaryRes, monthlyRes, yearlyRes, shopRes, categoryRes, statsRes] = await Promise.all([
                    fetchData('summary'),
                    fetchData('monthly'),
                    fetchData('yearly'),
                    fetchData('shop', { limit: 20 }),
                    fetchData('category'),
                    fetchData('stats')
                ]);

                console.log('API Responses:', { summaryRes, monthlyRes, yearlyRes, shopRes, categoryRes, statsRes });

                if (!summaryRes.success) {
                    throw new Error('Summary API failed: ' + (summaryRes.error || 'Unknown error'));
                }

                if (!summaryRes.data) {
                    showNoData();
                    return;
                }

                renderDashboard({
                    summary: summaryRes.data,
                    monthlyData: monthlyRes.success ? monthlyRes.data : [],
                    yearlyData: yearlyRes.success ? yearlyRes.data : [],
                    shopData: shopRes.success ? shopRes.data : [],
                    categoryData: categoryRes.success ? categoryRes.data : [],
                    weekdayStats: statsRes.success && statsRes.data ? statsRes.data.weekday : [],
                    seasonalStats: statsRes.success && statsRes.data ? statsRes.data.seasonal : []
                });

                console.log('Dashboard rendered successfully');
            } catch (err) {
                console.error('Error loading data:', err);
                showError(err.message);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Language toggle
            document.getElementById('langToggle').addEventListener('click', () => {
                switchLanguage(currentLang === 'en' ? 'ja' : 'en');
            });

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Load data
            loadAllData();
        });
    </script>
</body>
</html>
